<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Puppetronics Mini‑Game · Dialogues + Custom Art</title>
  <style>
    :root{--bg:#0b0b12;--ink:#e8e8f0;--accent:#8ae3ff;--accent2:#ff8ad8;--warn:#ffb366}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 700px at 70% -10%, #172033 0%, #0b0b12 60%);} 
    body{color:var(--ink);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji"}
    header{position:fixed;inset:0 0 auto 0;display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:.6rem 1rem;background:linear-gradient(180deg, rgba(7,9,15,.9), rgba(7,9,15,.2));backdrop-filter:saturate(140%) blur(6px);z-index:2}
    header .title{font-weight:650;letter-spacing:.3px}
    header .sub{opacity:.75}
    #wrap{position:relative;display:grid;place-items:center;height:100%;}
    #game{display:block;max-width:100%;outline:none;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06)}
    #hud{position:absolute;inset:auto 0 24px 0;display:flex;justify-content:center;gap:1rem;z-index:1;pointer-events:none}
    .pill{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.07);padding:.45rem .8rem;border-radius:999px;backdrop-filter:blur(3px)}
    .key{display:inline-grid;place-items:center;min-width:1.6rem;padding:.15rem .4rem;border-radius:.4rem;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15)}
    .btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:var(--ink);padding:.45rem .7rem;border-radius:.55rem;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,.12)}
    .toolbar{display:flex;gap:.5rem;align-items:center}
    .file{display:none}
    /* Dialogue box */
    .dialog{position:absolute;left:50%;bottom:28px;transform:translateX(-50%);width:min(860px, 90vw);background:rgba(7,9,15,.86);border:1px solid rgba(255,255,255,.14);padding:12px 14px 14px;border-radius:12px;box-shadow:0 8px 26px rgba(0,0,0,.5);}
    .dialog .name{font-weight:700;letter-spacing:.2px;margin-bottom:6px;color:var(--accent)}
    .dialog .text{white-space:pre-wrap;min-height:2.2em}
    .dialog .hint{opacity:.7;font-size:.85rem;margin-top:6px}
  </style>
</head>
<body>
  <header>
    <div class="toolbar">
      <span class="title">Puppetronics Mini‑Game</span>
      <span class="sub">· Arrows move · Space jump · E talk · R restart</span>
    </div>
    <div class="toolbar">
      <label class="btn" for="assetPicker">Add Your Drawing</label>
      <input id="assetPicker" class="file" type="file" accept="image/*" />
      <button class="btn" id="pauseBtn" aria-pressed="false">Pause</button>
    </div>
  </header>

  <div id="wrap">
    <canvas id="game" width="960" height="540" aria-label="Game canvas" tabindex="0"></canvas>
    <div id="hud">
      <div class="pill">Score: <span id="score">0</span></div>
      <div class="pill">Best: <span id="best">0</span></div>
      <div class="pill"><span class="key">←</span><span class="key">→</span> move · <span class="key">⎵</span> jump · <span class="key">E</span> talk</div>
    </div>
    <div id="dialog" class="dialog" style="display:none">
      <div class="name" id="dname">Speaker</div>
      <div class="text" id="dtext"></div>
      <div class="hint">Press <span class="key">Space</span> or <span class="key">Enter</span> to continue · <span class="key">Esc</span> to close</div>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const pauseBtn = document.getElementById('pauseBtn');
  const assetPicker = document.getElementById('assetPicker');
  const dialogEl = document.getElementById('dialog');
  const dnameEl = document.getElementById('dname');
  const dtextEl = document.getElementById('dtext');

  // Responsive scaling (keeps aspect ratio)
  function fit() {
    const pad = 16;
    const w = window.innerWidth - pad*2;
    const h = window.innerHeight - pad*2 - 80; // header height
    const scale = Math.min(w / canvas.width, h / canvas.height);
    canvas.style.transform = `scale(${scale})`;
  }
  window.addEventListener('resize', fit);
  fit();

  const rand = (min, max) => Math.random() * (max - min) + min;

  // World
  const G = 2100; const FRICTION = 0.88;
  const WIDTH = canvas.width, HEIGHT = canvas.height;
  const groundY = HEIGHT - 60;

  // Player (can render with custom image)
  const player = {
    x: 120, y: groundY - 18, r: 18, vx:0, vy:0, onGround:true,
    color1:'#9ae6ff', color2:'#f7b2ff', img:null, scale:1.8
  };
  // Pet follower (Choochoo)
  const pet = { x: player.x - 40, y: player.y, r: 10 };

  // Objects
  const sparks = []; const spikes = []; const npcs = [];

  // Spawn a talkable NPC occasionally (a glowing orb)
  function spawnNPC(){
    npcs.push({x: WIDTH+40, y: groundY-34, r: 14, vx:-200, talk:true, seen:false});
  }

  // Input
  const keys = new Set();
  window.addEventListener('keydown', e => {
    const k = e.key.toLowerCase(); keys.add(k);
    if (k === ' ' || e.code === 'Space') e.preventDefault();
  });
  window.addEventListener('keyup', e => keys.delete(e.key.toLowerCase()));

  // Pause / resume
  let paused = false; pauseBtn.onclick = ()=>{paused = !paused; pauseBtn.setAttribute('aria-pressed', paused); pauseBtn.textContent = paused? 'Resume' : 'Pause';}

  // Score
  let score = 0; let best = Number(localStorage.getItem('puppetronics_best')||0); bestEl.textContent = best;

  // Particles
  const particles = [];
  function emit(x,y,base,color){
    for(let i=0;i<base;i++) particles.push({x,y,vx:rand(-120,120), vy:rand(-220,-40), life:rand(.3,.8), age:0, color});
  }

  // Spawners
  let tSpark = 0, tSpike = 0, tNPC = 3;
  function spawnSpark(){ const y = rand(groundY-140, groundY-240); sparks.push({x: WIDTH + 40, y, r: 8, vx: -220}); }
  function spawnSpike(){ const size = 26; spikes.push({x: WIDTH + 60, y: groundY - size, w: size, h: size, vx: -240}); }

  // Helpers
  function circleRectCollide(cx, cy, r, rx, ry, rw, rh){
    const nx = Math.max(rx, Math.min(cx, rx + rw));
    const ny = Math.max(ry, Math.min(cy, ry + rh));
    const dx = cx - nx, dy = cy - ny; return (dx*dx + dy*dy) <= r*r;
  }
  const dist = (a,b)=>Math.hypot(a.x-b.x, a.y-b.y);

  // ==== Dialogue System ====
  const Dialogue = {
    active:false, idx:0, charIdx:0, current:null, speed:2.1, buffer:'', onEnd:null,
    script:[
      {name:'Lenny', text:"Choochoo… do you feel the market spirits tonight?"},
      {name:'Choochoo', text:"woof (softly)."},
      {name:'Spirit', text:"Traveler of strings and paper, collect sparks to awaken the puppets."},
    ],
    start(seq, onEnd){ this.active=true; this.idx=0; this.charIdx=0; this.script=seq||this.script; this.onEnd=onEnd||null; this.current=this.script[0]; dnameEl.textContent=this.current.name; dtextEl.textContent=''; dialogEl.style.display='block'; },
    close(){ this.active=false; dialogEl.style.display='none'; this.buffer=''; },
    next(){ this.idx++; if (this.idx>=this.script.length){ this.close(); if(this.onEnd) this.onEnd(); return; } this.current=this.script[this.idx]; this.charIdx=0; this.buffer=''; dnameEl.textContent=this.current.name; dtextEl.textContent=''; },
    update(dt){ if(!this.active) return; // typewriter
      const target = this.current.text; this.charIdx = Math.min(target.length, this.charIdx + this.speed);
      this.buffer = target.slice(0, Math.floor(this.charIdx)); dtextEl.textContent = this.buffer;
    }
  };

  // Start dialogue when pressing E near an NPC
  function tryTalk(){
    for(const n of npcs){ if (dist(n, player) < 70){
      Dialogue.start([
        {name:'Spirit', text:'Hello, Lenny. Drop your drawing here, and I will give it life.'},
        {name:'Lenny', text:'Deal. But you must help me cross these spikes.'},
        {name:'Spirit', text:'Collect three sparks and I shall lift them.'}
      ]);
      break;
    }}
  }

  // Game state
  let gameOver = false;
  function reset(){
    player.x = 120; player.y = groundY - player.r; player.vx = 0; player.vy = 0; player.onGround = true;
    pet.x = player.x - 40; pet.y = player.y;
    sparks.length = 0; spikes.length = 0; particles.length = 0; npcs.length = 0;
    tSpark = 0; tSpike = 0; tNPC = 3; score = 0; scoreEl.textContent = score; gameOver = false; Dialogue.close();
  }
  window.addEventListener('keydown', e => { if ((e.key === 'r' || e.key === 'R') && gameOver) reset(); });

  // Key handling for dialogue
  window.addEventListener('keydown', e => {
    if (!Dialogue.active) return;
    if (e.key === 'Escape'){ Dialogue.close(); return; }
    if (e.key === ' ' || e.key === 'Enter'){ e.preventDefault();
      if (Dialogue.buffer !== Dialogue.current?.text){ Dialogue.charIdx = (Dialogue.current?.text||'').length; return; }
      Dialogue.next();
    }
  });

  // Drag & drop OR file picker to load custom drawing for the player
  function useImageFromFile(file){
    const url = URL.createObjectURL(file);
    const img = new Image(); img.onload = ()=>{ player.img = img; URL.revokeObjectURL(url); }; img.src = url;
  }
  assetPicker.addEventListener('change', e => { const f=e.target.files?.[0]; if (f) useImageFromFile(f); });
  canvas.addEventListener('dragover', e => { e.preventDefault(); });
  canvas.addEventListener('drop', e => { e.preventDefault(); const f = e.dataTransfer?.files?.[0]; if (f && f.type.startsWith('image/')) useImageFromFile(f); });

  // Main loop
  let last = performance.now();
  function frame(now){
    requestAnimationFrame(frame);
    const dt = Math.min(0.033, (now - last) / 1000);
    if (paused) { last = now; return; }
    update(dt); draw(); last = now;
  }
  requestAnimationFrame(frame);

  function update(dt){
    // Input → velocity (disabled while in dialogue)
    const speed = 460;
    if (!gameOver){
      if (!Dialogue.active){
        if (keys.has('arrowleft') || keys.has('a')) player.vx = -speed; else if (keys.has('arrowright') || keys.has('d')) player.vx = speed; else player.vx *= FRICTION;
        if ((keys.has(' ') || keys.has('arrowup') || keys.has('w')) && player.onGround){ player.vy = -720; player.onGround = false; emit(player.x, player.y+player.r, 12, 'rgba(255,255,255,.6)'); }
        if (keys.has('e')) tryTalk();
      } else {
        player.vx *= FRICTION; // gentle halt during dialogue
      }
    } else { player.vx *= FRICTION; }

    // Gravity
    player.vy += G*dt;

    // Integrate
    player.x += player.vx*dt; player.y += player.vy*dt;

    // Boundaries & ground
    player.x = Math.max(player.r, Math.min(WIDTH - player.r, player.x));
    if (player.y + player.r >= groundY){ player.y = groundY - player.r; player.vy = 0; player.onGround = true; }

    // Pet follows with a springy lag
    const k = 12; const damping = 0.85; let dx = player.x - pet.x - 30; let dy = player.y - pet.y + 6; pet.vx = (pet.vx||0) * damping + dx * k * dt; pet.vy = (pet.vy||0) * damping + dy * k * dt; pet.x += pet.vx * dt; pet.y += pet.vy * dt;

    // Spawns
    tSpark -= dt; tSpike -= dt; tNPC -= dt;
    if (!Dialogue.active){
      if (tSpark <= 0){ spawnSpark(); tSpark = rand(0.8, 1.6); }
      if (tSpike <= 0){ spawnSpike(); tSpike = rand(1.2, 2.2); }
      if (tNPC <= 0){ spawnNPC(); tNPC = rand(6, 10); }
    }

    // Move world objects
    for (const s of sparks){ s.x += s.vx*dt; }
    for (const sp of spikes){ sp.x += sp.vx*dt; }
    for (const n of npcs){ n.x += n.vx*dt; }

    // Collect spark
    for (let i=sparks.length-1;i>=0;i--){
      const s = sparks[i];
      if (circleRectCollide(player.x, player.y, player.r, s.x-s.r, s.y-s.r, s.r*2, s.r*2)){
        sparks.splice(i,1); score += 10; scoreEl.textContent = score; emit(s.x, s.y, 18, 'rgba(138,227,255,.9)');
      } else if (s.x < -40) sparks.splice(i,1);
    }

    // Hit spike
    if (!gameOver && !Dialogue.active){
      for (const sp of spikes){ if (circleRectCollide(player.x, player.y, player.r, sp.x, sp.y, sp.w, sp.h)){
          gameOver = true; emit(player.x, player.y, 36, 'rgba(255,179,102,.95)'); best = Math.max(best, score); localStorage.setItem('puppetronics_best', best); bestEl.textContent = best; break; }
      }
    }

    // Particles
    for (let i=particles.length-1;i>=0;i--){ const p = particles[i]; p.age += dt; p.x += p.vx*dt; p.y += p.vy*dt; p.vy += 1200*dt; if (p.age > p.life) particles.splice(i,1); }

    // Dialogue typing
    Dialogue.update(dt);
  }

  function draw(){
    ctx.clearRect(0,0,WIDTH,HEIGHT);

    // Parallax sky lines
    const t = performance.now()/1000; for(let i=0;i<3;i++){ ctx.fillStyle = `rgba(255,255,255,${0.04 + i*0.03})`; const y = 60 + i*28 + Math.sin(t*.6 + i)*8; ctx.fillRect(0,y,WIDTH,1); }

    // Ground
    ctx.fillStyle = '#0e1524'; ctx.fillRect(0, groundY, WIDTH, HEIGHT-groundY);
    ctx.fillStyle = 'rgba(255,255,255,.05)'; for (let x=0; x<WIDTH; x+=24) ctx.fillRect(x, groundY+24, 12, 2);

    // Spikes
    for (const sp of spikes){ ctx.fillStyle = 'rgba(255,179,102,.9)'; ctx.beginPath(); ctx.moveTo(sp.x, sp.y+sp.h); ctx.lineTo(sp.x+sp.w/2, sp.y); ctx.lineTo(sp.x+sp.w, sp.y+sp.h); ctx.closePath(); ctx.fill(); }

    // Sparks
    for (const s of sparks){ const g = ctx.createRadialGradient(s.x, s.y, 2, s.x, s.y, s.r); g.addColorStop(0, 'rgba(138,227,255,1)'); g.addColorStop(1, 'rgba(138,227,255,0)'); ctx.fillStyle = g; ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill(); }

    // NPCs (glow spirits)
    for (const n of npcs){ const g = ctx.createRadialGradient(n.x, n.y, 2, n.x, n.y, n.r*1.8); g.addColorStop(0, 'rgba(255,138,216,1)'); g.addColorStop(1, 'rgba(255,138,216,0)'); ctx.fillStyle = g; ctx.beginPath(); ctx.arc(n.x, n.y, n.r, 0, Math.PI*2); ctx.fill(); if (dist(n,player)<90){ ctx.fillStyle='rgba(255,255,255,.8)'; ctx.font='600 12px system-ui'; ctx.textAlign='center'; ctx.fillText('Press E to talk', n.x, n.y - n.r - 10); }}

    // Pet (trail)
    ctx.fillStyle = 'rgba(255,255,255,.15)'; ctx.beginPath(); ctx.arc(pet.x, pet.y, pet.r, 0, Math.PI*2); ctx.fill();

    // Player (image if present)
    if (player.img){
      const w = player.r*2*player.scale; const h = w; // square-ish for simplicity
      ctx.save(); ctx.translate(player.x, player.y); ctx.drawImage(player.img, -w/2, -h/2, w, h); ctx.restore();
    } else {
      // fallback disc avatar
      const grad = ctx.createLinearGradient(player.x-player.r, player.y-player.r, player.x+player.r, player.y+player.r); grad.addColorStop(0, player.color1); grad.addColorStop(1, player.color2); ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#0b0b12'; ctx.beginPath(); ctx.arc(player.x+5, player.y-4, 2.2, 0, Math.PI*2); ctx.fill();
    }

    // Particles
    for (const p of particles){ const a = 1 - (p.age / p.life); ctx.fillStyle = p.color.replace(')', `, ${Math.max(0,a)})`).replace('rgb', 'rgba'); ctx.fillRect(p.x, p.y, 2, 2); }

    // Game over overlay
    if (gameOver){ ctx.fillStyle = 'rgba(0,0,0,.45)'; ctx.fillRect(0,0,WIDTH,HEIGHT); ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.font = '700 28px system-ui, sans-serif'; ctx.fillText('Game Over', WIDTH/2, HEIGHT/2 - 8); ctx.font = '500 16px system-ui, sans-serif'; ctx.fillText('Press R to restart', WIDTH/2, HEIGHT/2 + 18); }
  }

  // Focus canvas
  canvas.focus();
})();
</script>
</body>
</html>
